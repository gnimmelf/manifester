<!DOCTYPE html>
  <html lang="en">
  <head>
    <title>{{siteName}}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
      html, body {
        height: 100%;
      }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.js"></script>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
  </head>

  <body>
    <div data-ui-role="content" class="container">

      <h1 class="text-center">{{siteName}}</h1>
      <h2 class="text-center">Log in</h2>

      <div class="hidden alert" role="alert">
        This is an alert â€”check it out!
      </div>

      <div class="hidden loader"></div>

      <form class="request-code form" autocomplete="off">
        <div class="form-group text-center">
          {{label "email" "Enter your e-mail address"}}
          {{input "email" email placeholder="you@example.com" class="form-control text-center"}}
          <small class="form-text text-muted">
            We will e-mail you a code that you must use to log in.
          </small>
        </div>

        {{submit "request-code" "Mail me a login code" class="btn btn-primary btn-lg btn-block"}}
      </form>

      <form class="hidden validate-code form" autocomplete="off">
        <div class="form-group text-center">
          {{label "code" "Enter login code"}}
          {{input "code" code placeholder="Your login code" class="form-control text-center"}}
          <small class="form-text text-muted">
            Check your spam-folder if you cannot find the mail from {{siteName}}.
          </small>
        </div>

        {{submit "validate-code" "Validate login code" class="btn btn-primary btn-lg btn-block"}}
      </form>

    </div>
  </body>
  <script>
    ;(function ($) {
      // Make jQuery BS compat...
      var show = $.fn.show;
      var hide = $.fn.hide;
      $.fn.show = function() { this.removeClass("hidden"); show.call(this); };
      $.fn.hide = function() { this.addClass("hidden"); hide.call(this); };
    })(jQuery);

    ;(function($) {
      var reEmail = /^(([^<>()\[\]\.,;:\s@\"]+(\.[^<>()\[\]\.,;:\s@\"]+)*)|(\".+\"))@(([^<>()[\]\.,;:\s@\"]+\.)+[^<>()[\]\.,;:\s@\"]{2,})$/i;
      var alertElm = $("div.alert");
      var loaderElm = $("div.loader");
      var requestCodeForm = $(".request-code.form");
      var validateCodeForm = $(".validate-code.form");

      ;[requestCodeForm, validateCodeForm].forEach(function(form) {
        form.submit(function(evt) { evt.preventDefault(); });
      })

      // The element to recieve focus
      var focusElm = $('input[name=email');
      focusElm.focus();

      function alert(text, contextualStyle) {
        focusElm.focus();
        alertElm
          .html(text)
          .attr('class', "text-center alert alert-"+contextualStyle)
          .show();
      };

      function handleXhrError(data) {
        // Server error
        alert("Wops! Server failure:<br/>"+[data.name, data.message].join(': '), "danger")
      }

      requestCodeForm.submit(function(evt) {
        var email = $('input[name=email').val();
        if (email) {
          if (!reEmail.test(email)) {
            alert("Invalid e-mail address", "warning")
          }
          else {
            alert("Please wait, authenticating ("+email+")...", "info");
            requestCodeForm.hide();
            loaderElm.show();
            $.getJSON('{{authpath}}'+email)
              .always(function () {
                loaderElm.hide();
              })
              .done(function(data) {
                if (data.status == "fail") {
                  requestCodeForm.show();
                  alert(
                    ["E-mail address not found ("+email+").",
                    "-Did you type it correctly?"].join("<br/>"), "warning");
                }
                else {
                  // Success
                  validateCodeForm.show();
                  alert("Check your e-mail for a mail from us!", "success");
                }

              })
              .fail(handleXhrError)
          }
        }
      });


      validateCodeForm.submit(function(evt) {
        var code = $('input[name=code').val();
        var email = $('input[name=email').val();
        if (code) {
          if (!reCode.test(code)) {
            alert("Invalid login code", "warning")
          }
          else {
            alert("Please wait, authenticating ("+code+")...", "info");
            validateCodeForm.hide();
            loaderElm.show();
            $.getJSON('{{authpath}}'+email+"/"+code)
              .always(function () {
                loaderElm.hide();
              })
              .done(function(data) {
                if (data.status == "fail") {
                  requestCodeForm.show();
                  alert(
                    ["E-mail address not found ("+email+").",
                    "-Did you type it correctly?"].join("<br/>"), "warning");
                }
                else {
                  // Success
                  validateCodeForm.show();
                  alert("Check your e-mail for a mail from us!", "success");
                }

              })
              .fail(handleXhrError)
          }
        }
      });


    })(jQuery)
  </script>
<style>
.loader,
.loader:before,
.loader:after {
  border-radius: 50%;
  width: 2.5em;
  height: 2.5em;
  -webkit-animation-fill-mode: both;
  animation-fill-mode: both;
  -webkit-animation: load7 1.8s infinite ease-in-out;
  animation: load7 1.8s infinite ease-in-out;
}
.loader {
  color: #000000;
  font-size: 10px;
  margin: 80px auto;
  position: relative;
  text-indent: -9999em;
  -webkit-transform: translateZ(0);
  -ms-transform: translateZ(0);
  transform: translateZ(0);
  -webkit-animation-delay: -0.16s;
  animation-delay: -0.16s;
}
.loader:before,
.loader:after {
  content: '';
  position: absolute;
  top: 0;
}
.loader:before {
  left: -3.5em;
  -webkit-animation-delay: -0.32s;
  animation-delay: -0.32s;
}
.loader:after {
  left: 3.5em;
}
@-webkit-keyframes load7 {
  0%,
  80%,
  100% {
    box-shadow: 0 2.5em 0 -1.3em;
  }
  40% {
    box-shadow: 0 2.5em 0 0;
  }
}
@keyframes load7 {
  0%,
  80%,
  100% {
    box-shadow: 0 2.5em 0 -1.3em;
  }
  40% {
    box-shadow: 0 2.5em 0 0;
  }
}
</style>
</html>